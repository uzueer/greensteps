{% extends 'tracker/base.html' %}

{% block title %}Add Activity - GreenSteps{% endblock %}

{% block content %}
<div class="container">
    <div class="form-container">
        <h2>Add New Activity</h2>
        <p class="subtitle">Track your carbon footprint by logging activities</p>

        <form method="post" class="activity-form">
            {% csrf_token %}

            <div class="form-group">
                <label for="category">Category</label>
                <select id="category" name="category" required>
                    <option value="">Select a category</option>
                    {% for category in categories %}
                    <option value="{{ category.id }}">{{ category.icon }} {{ category.name }}</option>
                    {% endfor %}
                </select>
            </div>

            <div class="form-group">
                <label for="emission_factor">Activity Type</label>
                <select id="emission_factor" name="emission_factor" required disabled>
                    <option value="">Select category first</option>
                </select>
            </div>

            <div class="form-group">
                <label for="quantity">Quantity</label>
                <input type="number" id="quantity" name="quantity" step="0.01" min="0" required>
                <small class="form-help" id="unit-display">Enter quantity</small>
            </div>

            <div class="form-group">
                <label for="date">Date</label>
                <input type="date" id="date" name="date" required>
            </div>

            <div class="form-group">
                <label for="notes">Notes (optional)</label>
                <textarea id="notes" name="notes" rows="3" placeholder="Add any additional notes..."></textarea>
            </div>

            <div class="form-actions">
                <a href="{% url 'dashboard' %}" class="btn btn-secondary">Cancel</a>
                <button type="submit" class="btn btn-primary">Add Activity</button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const categorySelect = document.getElementById('category');
    const emissionFactorSelect = document.getElementById('emission_factor');
    const unitDisplay = document.getElementById('unit-display');
    const dateInput = document.getElementById('date');

    dateInput.valueAsDate = new Date();

    categorySelect.addEventListener('change', function() {
        const categoryId = this.value;

        if (!categoryId) {
            emissionFactorSelect.innerHTML = '<option value="">Select category first</option>';
            emissionFactorSelect.disabled = true;
            return;
        }

        fetch(`/api/emission-factors/?category_id=${categoryId}`)
            .then(response => response.json())
            .then(data => {
                emissionFactorSelect.innerHTML = '<option value="">Select activity type</option>';

                data.forEach(factor => {
                    const option = document.createElement('option');
                    option.value = factor.id;
                    option.textContent = `${factor.activity_name} (${factor.co2_per_unit} kg COâ‚‚/${factor.unit})`;
                    option.dataset.unit = factor.unit;
                    emissionFactorSelect.appendChild(option);
                });

                emissionFactorSelect.disabled = false;
            });
    });

    emissionFactorSelect.addEventListener('change', function() {
        const selectedOption = this.options[this.selectedIndex];
        if (selectedOption.dataset.unit) {
            unitDisplay.textContent = `Enter quantity in ${selectedOption.dataset.unit}`;
        } else {
            unitDisplay.textContent = 'Enter quantity';
        }
    });
});
</script>
{% endblock %}
